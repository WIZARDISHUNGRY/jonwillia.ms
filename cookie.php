<?php
function national_treasure_starring_nicholas_cage($log_matches)
{
	header("P3P: CP=\"DSP IDC CUR ADM PSA PSDi OTPi DELi STP NAV COM UNI INT PHY DEM\"");
	$irefs = Array(
	'#images.google.#',
	'#ilxor.com/#'
	);
	$refs = array(
	"#last.?fm#",
	'#myspace.com#',
	'#facebook.com#',
	'#flickr.com#',
	'#yelp.com#',
	'#twitter.com#',
	'#youtube.com#',
	'#jon#',
	'#del.icio.us#',
	"#silver.cloud#",
	'#williams#',
	'#ilxor.com#',
	'#ilx.wh3rd.net#',
	'#ilx.p3r.net#',
	'#ilx.thehold.net#',
    '#tumblr#',
    '#limewire#',
	'#wizardishungry.wordpress#',
    '#excepter#',
    '#rhizome#',
    '#=wizardishungry#',
    '#pachyhedron#',
    '#hedron#',
	);

	$lurkers = array(
    '69.114.63.236', // jfr
    'e1dcbaccc8241441146dc03936979f07', // ^
    '76.8.67.2', // limewire
//	"128.122.226.112",
'd9e63311cca142437584be08d6a81b07',    '66.227.31.5', // leah
"883d8709ee4407018280ed52dbdd9d67",	"88.107.124.203", // googler who hit tw?
"38de3b1a3bc479e503ff21f229b790d0",    "216.220.231.226", // alana
"70c1632ad3cd7c8db2eb619d2c2a1fde",    "24.89.152.74", // okcupid?  
// WAP
"72.89.216.130", // bushi 
"71.167.219.141", // bushburg
'71.167.207.58', //^
"208.120.235.132", // potion
"71.249.108.182", // tpb
// /WAP
"19d6f5e80bf2d5b988d61ee5c50dc59e",    "75.13.36.4", // hannah
"d2e1dd709eb1885c79fa67c3da0491ae",    "151.196.126.100", // drew
'4e1e54c92c3e0bac10f65469ee30ac4',	'72.229.14.222', //britta w
'2c0ee82e67c74c5e162282c0663e3d6b',    '128.122.240.145', // phil r
"6427b9852ad66ef41abe06df5cef7496", // leah
"0b3c6c5a85557421b87582e685fb7324",	"75.222.66.123", //^
"6bf6fea6da212771ab1324b8906c20e0", // yahoo
'208.73.184.66', // tom 
"fa139e94c88b8d8a272347838cb8fa7b",    "128.122.50.164", // jodi
"5a67ed40d0ce2d6e93a506af6fbb6923",    "24.193.97.39", // peggy ^_^
"66.108.8.193", // some moron
"66.11.201.222", // twiggy
"a5c432d453c214a8adfbe66a32899380",    "72.227.132.124", // killy
"276dd446935059722d3902f163b451a1",    "69.114.177.148", // danielle
"64.131.135.173", // ellies
"0c110b763b7ac62101fd6126a74ce8d1", //^
"6bb6f94ead5be7c637cbd1263afc57b5", //^
"69.86.137.27", // e ellie
"74.73.109.169", // maG
"75aaa68f27a7ebae775830373e093aee", // ^
"24.90.5.222", "86ca909ccb252ec5486f9a4a2d0ac9eb", // saraphonic
'206.53.144.80', // lindsay
"1388e91f0bbc2e3f13c54aaf6d59de94", //claire
'134.174.21.2', // ^
"12.151.120.89", // linds
"216.73.251.101", // wboard
"69.114.194.147", // jodi
"737f2979440588b28b501e33ea1c38c9", // ^
"ca0ba56f1d368c1736b4364edecad7eb", // suncana
"208.120.1.149", // mo
"128.151.130.137", // u of r undergrad running linux
"198.151.217.26", // ally
"68.34.42.30", // md linux googled .com
"64.115.128.227", // googled .com
"7ed8feeec3ea015e8dd372296f208493", // ^
"208.120.239.243", // joel
"b1880985bd55a00ecb20ec0e96ff3ad4", // ^
"6a486c85f7fa47ee5c5822dee8ccb8e7", // potion user on mac
"69.86.59.16",   // googled wiz blog
"fb41b42409e69bda7e4af39a65cc362a", // ^
"24.39.119.109", // googled nnck
"213.137.127.166", // yugo googler
"194.51.29.163", // french googler
"146.203.12.136", // supervert
"209.10.160.97", // bookmarked
"71.167.211.113", // bloglines
 "64.131.210.158", // ME
//"70.167.20.35", // marc|k?
"bb5dedbb25fce86d4a78471d631e3", // ^
"66.65.67.142", //googled me
"7bf7e197d41a6430a40768297d6160bb", // ^
"76.170.195.89", // googled me
"24.105.139.82", // cat
"b189c9758ff0ff5447f4d1c17456b73c", // ^
"6430bb1dcdc08bc405b2c07ce88021d3", // ^
"8278a68f8ccdbb21c82eada4e2b5be9e", // n!cole
"71.249.107.193", // jessica
"69.207.183.235", //jane 
"daa3847e80bbdf84165f6dd617388beb", // jane? 
"60bc817d660ae56cfaa2e6a174863058", // ^
"71.249.97.207", // cat - ?
"24.105.139.82", // ^ cat ?
"b81cbbd66b40138bae5480a070fd4702",    "74.77.138.224", // kelly
"138.88.65.51", // flickr stalkr
	"68.161.126.82", // renee
		"24.193.154.124",	// jiwon
		"8d21cf9b90b57f9f08d778d41ec2f5ac", // ^
		"71.125.197.122", // image browser
		"c35c5298ad0d71e274923575f322a886", // ^
		"24.199.126.237", // some fucking creep -- nancy 
		"24.215.143.133", // same ips?
		"3534567ff2be00e61baf3a2f27faa411",
		"cdbb1ec5e79e923b0338755f2323a76b", // her roomie?
		"209.212.80.94", // carly
		"64.59.48.210", // allie j
		"89bd76ab487bd267efb59d75d54b3ef7", // ^
		"170.20.11.116", // sundance
		"94eb9cfcc53d0248d2f090aa46cd15ce", // ^
		"36c958e042cb32ced192c410069b4be9", // ^
		"f71d5fe288d77892aadedaa7668eebaf", // ^; val?
		"24.59.98.170", // no idea.. is a friend tho 
		"94fae93fe8e7621aeb223003da89e1d6", // ^
		"24.59.107.227", //^ laurab?
		"de03b9ed35a474d4769f739f7412cdc5", // ^
		"94fae93fe8e7621aeb223003da89e1d6", // ^
		"b45825c8c46493676cccfd0c5bc5e2d8", // ^
		"72.245.111.211", 	// laurah work
		"149.31.12.122", // new school
		"216.139.131.250", // some creep / friend
		"ea1cd9c1c7a100287b6ca59df63d8364", // ^
		"c410dc9fd8b58cd70f9697480f26605c" , // ^
		"2e2fe7eae74d1ea21cb238ffd9780d69",
		"166.77.103.133",
		"64.131.208.63", // me
		"64.131.211.236", //theresa
		"24.45.67.164", // some creep,maybe v; not friend 
		"847a7fa6366eddd9ecf75c4ee7d594b7",
		"24.188.229.208", // ^
		"71.242.172.82",
		"71.246.107.164", // KILLY
		"25aeba233af11738801c407590406d57", // ^
		"24.193.79.160",
		"205.232.74.128", // laura b work
		"24.46.140.145",
		"67.100.144.105",
		"24.90.13.136",
		"68.160.237.40", //russ
		"69.86.137.221",
		"859a0dad5145c2aa5289e8a35b43bcf3", // weird
		"24.223.240.243",
//		"209.10.160.121", // has bookmarked
		"69.112.244.23", // friend on nyu wlan... mike? 
		"070d5c2e364e3340dee4229d3ff15fa2", // ^
		"69.86.223.52"
		
		);

	$mode = "got";
	if($_COOKIE[LOLSESSIONID] == "")
	{
	
		$mode="set";
		$val = md5( mt_rand(). ":". time() . ":" . mt_rand() );
		setcookie("LOLSESSIONID",$val,2147483647,'/');
		$_COOKIE[LOLSESSIONID]=$val; // let other php scripts see cookie
	}
	else
	{
		$val = $_COOKIE[LOLSESSIONID];
	}

	if($log_matches==TRUE)
	{
		$ip=$_SERVER[REMOTE_ADDR];
		$url=$_SERVER[REQUEST_URI];
		$ref=$_SERVER[HTTP_REFERER];
		$key = array_search($val,$lurkers);
		if($key!==FALSE)
		{
			$desc="cookie";
			log_match($val,$mode,$ip,$url,$desc,$ref);
			return;
		}
		else
		{
			$key = array_search($ip,$lurkers);
			if($key!==FALSE)
		        {
				$desc="ipaddr";
				log_match($val,$mode,$ip,$url,$desc,$ref);
				return;
			}
		}


		$refm=FALSE;
		if(!preg_match('#^http://wizardishungry.com/#',$ref))
		foreach($refs as $c)
		{
			if(preg_match($c.'i',$ref))
			{
				$refm=TRUE;
				break;
			}
		}

		if($refm)
		{
		
			foreach($irefs as $c)
			{
				if(preg_match($c.'i',$ref))
				{
					$refm=false;
					break;
				}
			}
			if($refm)
			{
				$desc="ref";
				log_match($val,$mode,$ip,$url,$desc,$ref);
				return;
			}
		}

                if($log_matches===3)
                {
                        $desc="tracker";
                        log_match($val,$mode,$ip,$url,$desc,$ref);
                        return;
                }
	}
}

function log_match($val,$mode,$ip,$url,$desc,$ref)
{
$ignore = Array(
'5a5a89062d91c89ad91cad1eab98f658',
'9e8e0e1a82410ae8c9efd8e5a826b1f3',
'2796d9263d683336e78ac70fac8d22d7',	'128.122.226.112',
'2c218d80213cf1b56278c3cea9713dcc',
'246d39c013ab446cb69f6b554564261e',
'76387fc336cfe5c4540258105e87221a',
'2cab113dd351c8e80a23ca38fc4defc1',
'9b00dff44a1b9eae653d10ec6618d20d',
'c22d826f55d143141f5415bb546c14c0',
'abe56cf30dfa7270c0443d1856252e15',
'bae12a104efa9f30ca7043ce8d4da15b',
'3d7b71063dbee99b859b67298a68d9ce',
'2f55e7189ea8e5d2e54cef1c9f54546f',
'5c93489aa9518f38363f37e4307962bf',
'537eff87db7d7eea7c1e555fef03688e',
'208.120.236.28',
'5367ccd419357fc15f0dfb5834840fdf',
'611311b621fe070ae09a38cd5c6fb5ba',
);
	if(array_search($val,$ignore)!==FALSE) return ; 
	if(array_search($ip,$ignore)!==FALSE) return ;
	
	$handle = fopen ("/var/www/lurkers","a");
	if($handle)
	{
		$t=date("r");
		fwrite($handle, "$t\t$mode $val\t$ip\t($desc)\t$url\t$ref\n");
		fclose ($handle);
	}
}
?>
